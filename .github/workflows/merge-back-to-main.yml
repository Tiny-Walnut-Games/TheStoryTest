name: ðŸ”„ Merge Release Back to Main

# After successful release, merges release branch back to main and develop
# Maintains branch consistency and prevents drift

on:
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write

jobs:
  merge-back:
    name: ðŸ”„ Merge release â†’ main â†’ develop
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”§ Configure Git
        run: |
          git config --global user.name "Story Test Bot"
          git config --global user.email "bot@tinywalnutgames.com"

      - name: ðŸ“ Get current version
        id: version
        run: |
          VERSION=$(jq -r '.version' Packages/com.tinywalnutgames.storytest/package.json)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ðŸ“Œ Current version: $VERSION"

      - name: ðŸ”€ Merge release â†’ main
        run: |
          git fetch origin
          git checkout main
          git merge origin/release --no-ff -m "ðŸ”€ Merge release v${{ steps.version.outputs.version }} to main"
          git push origin main
          echo "âœ… Successfully merged release to main"

      - name: ðŸ”€ Merge main â†’ develop
        run: |
          git fetch origin
          git checkout develop
          git merge origin/main --no-ff -m "ðŸ”€ Merge main back to develop after release v${{ steps.version.outputs.version }}"
          git push origin develop
          echo "âœ… Successfully merged main to develop"

      - name: ðŸ“¢ Notify
        run: |
          echo "âœ… Release v${{ steps.version.outputs.version }} propagated to all branches"
          echo "ðŸ“Š Branch Status:"
          echo "  - main: Updated with release"
          echo "  - develop: Updated with latest from main"
          echo "  - release: Ready for next release cycle"