name: Story Test Validation

# Note: Local linter warnings are expected and will resolve when pushed to GitHub
# The linter cannot access GitHub's action registry from your local workspace

on:
  push:
    branches: [ main, develop, release, 'jmeyer1980/**' ]
  pull_request:
    branches: [ main, develop, release ]
  workflow_dispatch:
    inputs:
      run-windows:
        description: "Run Windows Story Test job"
        required: false
        default: "false"
      run-macos:
        description: "Run macOS Story Test job"
        required: false
        default: "false"

jobs:
  # Fast feedback job - quick static analysis of source files (completes in ~30 seconds)
  quick-validation:
    name: Quick Static Analysis
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'
      
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # Quick syntax/static validation without compilation
      - name: Run Story Test Static Analysis (Fast)
        id: story-test-quick
        continue-on-error: true
        run: |
          # Validate C# source files for syntax errors and basic issues
          # This provides quick feedback without waiting for Unity compilation
          echo "Running static analysis on C# source files..."
          
          # Check for common Story Test violations with line numbers
          echo "## Story Test Pattern Violations" > violations.txt
          echo "" >> violations.txt
          
          # Search for NotImplementedException with context
          echo "### NotImplementedException Found:" >> violations.txt
          grep -rn "NotImplementedException" Packages/com.tinywalnutgames.storytest --include="*.cs" | head -20 >> violations.txt || echo "None" >> violations.txt
          echo "" >> violations.txt
          
          # Search for TODO comments with context
          echo "### TODO Comments Found:" >> violations.txt
          grep -rn "TODO" Packages/com.tinywalnutgames.storytest --include="*.cs" | head -20 >> violations.txt || echo "None" >> violations.txt
          echo "" >> violations.txt
          
          # Search for throw new patterns
          echo "### Throw Statements Found:" >> violations.txt
          grep -rn "throw new" Packages/com.tinywalnutgames.storytest --include="*.cs" | head -20 >> violations.txt || echo "None" >> violations.txt
          
          # Display results
          cat violations.txt
          
          # Note: Full IL bytecode analysis happens in Unity build jobs
          echo ""
          echo "âœ… Quick static analysis complete. Full validation runs in Unity build jobs below."
      
      - name: Upload Quick Validation Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: story-test-report-quick
          path: violations.txt
      
      - name: Display Quick Results
        if: always()
        shell: bash
        run: |
          echo "## ðŸš€ Quick Static Analysis Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This is a lightweight pre-check that scans source code for common violations." >> $GITHUB_STEP_SUMMARY
          echo "Full IL bytecode validation runs in the Unity build jobs below." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ -f violations.txt ]; then
            echo "### Pattern Analysis" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            cat violations.txt >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "These patterns may indicate Story Test doctrine violations." >> $GITHUB_STEP_SUMMARY
            echo "Check Unity build results for definitive validation with IL bytecode analysis." >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… **No violations.txt generated!**" >> $GITHUB_STEP_SUMMARY
          fi
      
      # Don't fail on quick validation - it's just a pre-check
  
  # Canonical validation runs automatically on every push/PR (Linux)
  story-test-linux:
    name: Story Test - Linux (Canonical)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Samples~/ExampleProject/Library
          key: >-
            Library-ubuntu-latest-6000.2.6f2-${{ hashFiles(
              'Packages/com.tinywalnutgames.storytest/**',
              'Samples~/ExampleProject/Assets/**',
              'Samples~/ExampleProject/Packages/manifest.json',
              'Samples~/ExampleProject/Packages/packages-lock.json',
              'Samples~/ExampleProject/ProjectSettings/ProjectVersion.txt'
            ) }}
          restore-keys: |
            Library-ubuntu-latest-6000.2.6f2-
            Library-ubuntu-latest-

      # Note: Unity secrets (UNITY_LICENSE, UNITY_EMAIL, UNITY_PASSWORD) must be added to repository Settings > Secrets
      # See https://game.ci/docs/github/activation for setup instructions
      # yamllint disable-line rule:line-length
      - name: Build Sample Project (to generate assemblies)
        uses: game-ci/unity-builder@v4
        env:
          # These secrets must be configured in repository settings - warnings are expected until configured
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}  # pragma: allowlist secret
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}  # pragma: allowlist secret
        with:
          projectPath: Samples~/ExampleProject
          unityVersion: '6000.2.6f2'
          targetPlatform: StandaloneLinux64
          buildName: StoryTestSampleBuild

      - name: Run Story Test Validation
        id: story-test-linux
        continue-on-error: true
        run: |
          python scripts/story_test.py Samples~/ExampleProject --verbose --output story-test-report.json --fail-on-violations
        shell: bash

      - name: Upload Story Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: story-test-report-ubuntu
          path: story-test-report.json

      - name: Parse and Display Results
        if: always()
        shell: bash
        run: |
          if [ -f story-test-report.json ]; then
            echo "## Story Test Results - Linux" >> $GITHUB_STEP_SUMMARY

            TOTAL=$(jq '.totalViolations' story-test-report.json)

            if [ "$TOTAL" -eq 0 ]; then
              echo "âœ… **No violations found!** Code narrative is complete." >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Found $TOTAL violation(s)**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Violations by Type" >> $GITHUB_STEP_SUMMARY
              jq -r '.violationsByType | to_entries[] | "- **\(.key)**: \(.value)"' story-test-report.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Violation Details" >> $GITHUB_STEP_SUMMARY
              jq -r '.violations[] | "- `\(.type).\(.member)`: \(.violation)"' story-test-report.json >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Story test report not generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if violations found
        if: steps.story-test-linux.outcome == 'failure'
        run: |
          echo "Story Test validation failed. Review the violations above."
          exit 1

  # Optional Windows validation - triggered manually via workflow_dispatch input
  story-test-windows:
    name: Story Test - Windows (Manual)
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run-windows == 'true'
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Samples~/ExampleProject/Library
          key: >-
            Library-windows-latest-6000.2.6f2-${{ hashFiles(
              'Packages/com.tinywalnutgames.storytest/**',
              'Samples~/ExampleProject/Assets/**',
              'Samples~/ExampleProject/Packages/manifest.json',
              'Samples~/ExampleProject/Packages/packages-lock.json',
              'Samples~/ExampleProject/ProjectSettings/ProjectVersion.txt'
            ) }}
          restore-keys: |
            Library-windows-latest-6000.2.6f2-
            Library-windows-latest-

      - name: Build Sample Project (to generate assemblies)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}  # pragma: allowlist secret
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}  # pragma: allowlist secret
        with:
          projectPath: Samples~/ExampleProject
          unityVersion: '6000.2.6f2'
          targetPlatform: StandaloneWindows64
          buildName: StoryTestSampleBuild

      - name: Run Story Test Validation
        id: story-test-windows
        continue-on-error: true
        run: |
          python scripts/story_test.py Samples~/ExampleProject --verbose --output story-test-report.json --fail-on-violations
        shell: bash

      - name: Upload Story Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: story-test-report-windows
          path: story-test-report.json

      - name: Parse and Display Results
        if: always()
        shell: bash
        run: |
          if [ -f story-test-report.json ]; then
            echo "## Story Test Results - Windows" >> $GITHUB_STEP_SUMMARY

            TOTAL=$(jq '.totalViolations' story-test-report.json)

            if [ "$TOTAL" -eq 0 ]; then
              echo "âœ… **No violations found!** Code narrative is complete." >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Found $TOTAL violation(s)**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Violations by Type" >> $GITHUB_STEP_SUMMARY
              jq -r '.violationsByType | to_entries[] | "- **\(.key)**: \(.value)"' story-test-report.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Violation Details" >> $GITHUB_STEP_SUMMARY
              jq -r '.violations[] | "- `\(.type).\(.member)`: \(.violation)"' story-test-report.json >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Story test report not generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if violations found
        if: steps.story-test-windows.outcome == 'failure'
        run: |
          echo "Story Test validation failed. Review the violations above."
          exit 1

  # Optional macOS validation - triggered manually via workflow_dispatch input
  story-test-macos:
    name: Story Test - macOS (Manual)
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run-macos == 'true'
    runs-on: macos-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'
          cache-dependency-path: 'requirements.txt'

      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: Samples~/ExampleProject/Library
          key: >-
            Library-macos-latest-6000.2.6f2-${{ hashFiles(
              'Packages/com.tinywalnutgames.storytest/**',
              'Samples~/ExampleProject/Assets/**',
              'Samples~/ExampleProject/Packages/manifest.json',
              'Samples~/ExampleProject/Packages/packages-lock.json',
              'Samples~/ExampleProject/ProjectSettings/ProjectVersion.txt'
            ) }}
          restore-keys: |
            Library-macos-latest-6000.2.6f2-
            Library-macos-latest-

      - name: Build Sample Project (to generate assemblies)
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}  # pragma: allowlist secret
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}  # pragma: allowlist secret
        with:
          projectPath: Samples~/ExampleProject
          unityVersion: '6000.2.6f2'
          targetPlatform: StandaloneOSX
          buildName: StoryTestSampleBuild

      - name: Run Story Test Validation
        id: story-test-macos
        continue-on-error: true
        run: |
          python scripts/story_test.py Samples~/ExampleProject --verbose --output story-test-report.json --fail-on-violations
        shell: bash

      - name: Upload Story Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: story-test-report-macos
          path: story-test-report.json

      - name: Parse and Display Results
        if: always()
        shell: bash
        run: |
          if [ -f story-test-report.json ]; then
            echo "## Story Test Results - macOS" >> $GITHUB_STEP_SUMMARY

            TOTAL=$(jq '.totalViolations' story-test-report.json)

            if [ "$TOTAL" -eq 0 ]; then
              echo "âœ… **No violations found!** Code narrative is complete." >> $GITHUB_STEP_SUMMARY
            else
              echo "âŒ **Found $TOTAL violation(s)**" >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Violations by Type" >> $GITHUB_STEP_SUMMARY
              jq -r '.violationsByType | to_entries[] | "- **\(.key)**: \(.value)"' story-test-report.json >> $GITHUB_STEP_SUMMARY
              echo "" >> $GITHUB_STEP_SUMMARY
              echo "### Violation Details" >> $GITHUB_STEP_SUMMARY
              jq -r '.violations[] | "- `\(.type).\(.member)`: \(.violation)"' story-test-report.json >> $GITHUB_STEP_SUMMARY
            fi
          else
            echo "âš ï¸ Story test report not generated" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Fail if violations found
        if: steps.story-test-macos.outcome == 'failure'
        run: |
          echo "Story Test validation failed. Review the violations above."
          exit 1

  # Alternative job for projects without Unity (pure C# libraries)
  story-test-dotnet:
    name: Story Test (C# Only) - ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    if: false  # Enable this if you have a non-Unity C# project
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        dotnet-version: ['7.0']
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ matrix.dotnet-version }}
      
      - name: Restore Dependencies
        run: dotnet restore
      
      - name: Build Project
        run: dotnet build --configuration Release --no-restore
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Python Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      - name: Run Story Test Validation
        run: |
          python story_test.py ./bin/Release --verbose --output story-test-report.json --fail-on-violations
      
      - name: Upload Story Test Report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: story-test-report-dotnet-${{ matrix.os }}
          path: story-test-report.json
